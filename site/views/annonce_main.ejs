<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="../image/logo.svg">
    <link rel="stylesheet" href="../css/main_annonce.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <title><%= ad.images %></title>
    <link rel="icon" type="image/svg+xml" href="../image/logo.svg">
</head>

<body>
    <div class="main">
        <header id="header"> 
            <div id="website-logo">
                <img class="logo" src="../image/logo.svg"  alt="Gradient Shape Logo Element" loading="lazy">
                <span class="title" ><a href=".." style="text-decoration:none; color: white;">&nbsp; LocaWeb </a> </span>  
                </div>
                
                <a id="sign_up" href="/login" class="btn-grad">Sign-up / Login</a>
    
                <% if (username !== undefined) { %>
                    <a id="username" class="btn-grad" href="#"> <%= username %> </a>
                    <a id="username" class="btn-offers btn-grad" href="/announces_builder"> Create offers </a>
                    <button onclick="toggleReport('0')" class="fas fa-flag" title="Report" value="0" id="r0"></button>
                    <form method="POST" style="background-color: transparent;" action="./<%= ad.id %>">
                        <input type="text" placeholder="Reason of the report" name="rep_content" id="0re" style="display: None;">
                        <button type="submit" name="type" value="adreport" id="0r" style="display: None;" >Rep</button>
                    </form>
                    

                    <script>
                        document.getElementById('sign_up').style.display='none';
                    </script>
                <% } %>
        </header>

        <div class="main_announce_container">
            <div class="announce_container_left">
                <div class="announce_images_container">
                    <div id="arrow_left">
                        <i class="fas fa-arrow-left"></i>
                    </div>

                    <div id="arrow_right">
                        <i class="fas fa-arrow-right"></i>
                    </div>

                    <div class="images_container" style=" height: 100%; width: 100%;">
                        <!-- Multiple images here -->
                        <img style="height: 100%; width: 100%; object-fit: contain;"  class="image" src="/uploads/<%= ad.images %>" alt="<%= ad.images %>">

                    </div>
                </div>
            </div>

            <div class="announce_container_right">
                <div class="announce_seller">
                    <!-- Le vendeur -->
                    <p class="selle_info"><%= user %></p>
                </div>

                <div class="announce_price">
                    <!-- Prix de l'article -->
                    <p class="selle_info"><%= ad.price %>€</p>
                </div>

                <div class="rent_article_button">
                    Bouton pour louer
                    <!-- Bouton pour louer le bien -->
                </div>
            </div>
        </div>

        <div class="announce_goto_comment_description">
            <a href="#blank_space" class="goto_comment">
                <p class="goto_text">
                    Description
                </p>
                <!-- Lien vers section commentaires -->
            </a>
            <a href="#announce_description" class="goto_description">
                <p class="goto_text">
                    Comments
                </p>
                <!-- Lien vers section description -->
            </a>
        </div>

        <div id="blank_space" style="height: 50px;"></div>

        <div id="announce_description">
            <div class="text_description">
                <!-- Description de l'article -->

                <p class="info_product">
                    <%= ad.description %>
                </p>
                
            </div>
            <input type="checkbox" class="moreless_announce_description">
        </div>

        <div class="announce_comment_container">
            <div id="announce_comment_text">
                <% for (main_c in comments) { %>
                    <% cur_m = comments[main_c] %>
                    <% date = cur_m.createdAt %>
                    <% id_m = cur_m.id %>
                <div class="announce_one_comment">
                    <div class="date_username">
                        <div class="comment_username">
                            <%=cur_m.username %>
                        </div>
                        <div class="comment_date">
                            <%= date %>
                        </div>
                        <button onclick="toggleReport('<%= id_m %>')" class="fas fa-flag" title="Report" value="0" id="r<%= id_m %>"></button>
                        <form method="POST" style="background-color: transparent;" action="./<%= ad.id %>">
                            <input type="hidden" name="type" value="coreport">
                            <input type="text" placeholder="Reason of the report" name="rep_content" id="<%= id_m %>re" style="display: None;">
                            <button type="submit" name="rep_btn" value="<%= id_m %>" id="<%= id_m %>r" style="display: None;" >Rep</button>
                        </form>
                    </div>
                    
                    <div class="comment_text">
                        <%= cur_m.content %>
                        <!-- <br> -->
                        <div class="icons">
                            <button type="button" class="fas fa-reply" onclick="toggleComment('<%= id_m %>')" value="0" id="b<%= id_m %>" title="Reply"></button>
                            <i class="fas fa-flag" title="Report"></i>
                        </div>
                        
                        <form method="POST" style="background-color: transparent;" action="./<%= ad.id %>">
                            <!-- <button onclick="toggleComment('<%= id_m %>')" type="button" class="reply_button_left" value="0" id="b<%= id_m %>">Reply</button> -->
                            <div class="type_and_send_content_reply" id="<%= id_m %>">
                                <input type="hidden" name="type" value="comment">
                                <input type="text" id="<%= id_m %>c" style="display: None;" class="comment_type_reply" name="res_content" placeholder="Type your text here">
                                <button type="submit" class="reply_button_right" id="<%= id_m %>b" value="<%= id_m %>|" name="res_btn" style="display: None;">Post</button>
                            </div>
                        </form>
                    </div>
                    <% for (sub_c in cur_m.responses) { %>
                        <% cur_sub = cur_m.responses[sub_c] %>
                        <% date = cur_sub.createdAt %>
                        <% id_sub = cur_sub.id %>
                        
                    <div class="comment_reply_text">
                        <div class="reply_user_date">
                            <div class="comment_reply_username">
                                <%= cur_sub.username %>
                            </div>
                            <div class="comment_reply_date">
                                <%= date %>
                                <button onclick="toggleReport('<%= id_sub %>')" class="fas fa-flag" title="Report" value="0" id="r<%= id_sub %>"></button>
                                <form method="POST" style="background-color: transparent;" action="./<%= ad.id %>">
                                    <input type="hidden" name="type" value="coreport">
                                    <input type="text" placeholder="Reason of the report" name="rep_content" id="<%= id_sub %>re" style="display: None;">
                                    <button type="submit" name="rep_btn" value="<%= id_sub %>" id="<%= id_sub %>r" style="display: None;" >Rep</button>
                                </form>
                            </div>
                        </div>
                        <div class="reply_text">
                            <% if (cur_sub.repAuthorId == userId) { %> <!-- Affiche le content en bleu si c'est une réponse au user conntecté -->
                                <!-- text to highlight                                | text not to highlight -->
                                <a style="padding: 3px; border-radius: 5px; border: 1px solid rgb(255, 0, 0); background-color: #ff00007c;"><%= cur_sub.toAuthor %></a> <%= cur_sub.content %>
                            <% } else { %>
                                <%= cur_sub.toAuthor %> <%= cur_sub.content %>
                            <% } %>
                            <!-- <br> -->
                            <div class="icons">
                                <button type="button" class="fas fa-reply" onclick="toggleComment('<%= id_sub %>')" value="0" id="b<%= id_sub %>" title="Reply"></button>
                                <i class="fas fa-flag" title="Report"></i>
                            </div>
                            
                            <form method="POST" style="background-color: transparent;" action="./<%= ad.id %>">
                                
                                <div class="type_and_send_content_reply" id="<%= id_sub %>">
                                    <input type="hidden" name="type" value="comment">
                                    <input type="text" id="<%= id_sub %>c" style="display: None;" class="comment_type_reply" name="res_content" placeholder="Type your text here">
                                    <button type="submit" class="reply_button_right" id="<%= id_sub %>b" value="<%= id_m %>|<%= id_sub %>" name="res_btn" style="display: None;">Post</button>
                                </div>
                            </form>
                        </div> 
                    </div>
                    <% } %>
                </div>
                <% } %>
            </div>
            <div class="announce_type_and_send">
                <form class="type_and_send_content" method="POST" action="./<%= ad.id %>">
                    <input type="text" name="res_content" class="comment_type_text" placeholder="Type your text here" required>
                    <button type="submit" name="res_btn" value="" class="comment_send_button" >SEND</button>
                </form>
            </div>
        </div>

        
        <!-- <footer>

        </footer> -->
        
    </div>


</body>
</html>

<script>
    const arrow_left = document.getElementById("arrow_left")
    const arrow_right = document.getElementById("arrow_right")

    arrow_left.addEventListener('mousein', mouseIn(arrow_right))
    arrow_left.addEventListener('mouseout', mouseOut(arrow_right))

    arrow_right.addEventListener('mousein', mouseIn(arrow_left))
    arrow_right.addEventListener('mouseout', mouseOut(arrow_left))

    function mouseIn(arrow) {
        arrow.setAttribute("style", "display:none;")
        arrow.setAttribute("style", "transition: all 0.2 ease-in-out;")
    }

    function mouseOut(arrow) {
        arrow.setAttribute("style", "display:block;")
        arrow.setAttribute("style", "transition: all 0.2 ease-in-out;")
    }

    //the following code comes from W3schools.com
    // When the user scrolls the page, execute stickHeader 
    window.onscroll = function() {stickHeader()};

    // Get the header
    var header = document.getElementById("header");

    // Get the offset position of the navbar
    var sticky = header.offsetTop;

    // Add the sticky class to the header when you reach its scroll position. Remove "sticky" when you leave the scroll position
    function stickHeader() {
        if (window.pageYOffset > sticky) {
            header.classList.add("sticky");
        } else {
            header.classList.remove("sticky");
        }
    }

    const objDiv = document.getElementById('announce_comment_text')
    objDiv.scrollTop = objDiv.scrollHeight;


    function toggleComment(id) {
        console.log("in")
        if (document.getElementById("b" + id).value == 0) {
            console.log(0)
            document.getElementById("b" + id).value = 1;
            document.getElementById(id + "c").style.display = "";
            document.getElementById(id+"b").style.display = "";
            document.getElementById(id).style.display="flex";
        } else {
            console.log(1)
            document.getElementById("b" + id).value = 0;
            document.getElementById(id + "c").style.display = "None";
            document.getElementById(id).style.display="None";
            document.getElementById(id+"b").style.display = "None";
        }
    }
    function toggleReport(id) {
        if (document.getElementById("r" + id).value == 0) {
            document.getElementById("r" + id).value = 1;
            document.getElementById(id+"r").style.display = "";
            document.getElementById(id + "re").style.display="flex";
        } else {
            document.getElementById("r" + id).value = 0;
            document.getElementById(id+ "re").style.display="None";
            document.getElementById(id+"r").style.display = "None";
        }
    }
</script>